sudo: false
services:
  - docker

install:
  - 'npm install -g mustache'
  - 'SERVICE_TAG=${SERVICE_TAG:-$TRAVIS_BRANCH}'
  - './ci-build.sh'
  - 'docker build -t experimentalplatform/configure:${SERVICE_TAG} .'

script:
  - 'docker run --rm experimentalplatform/configure:${SERVICE_TAG} /test.sh'

after_success:
  - '[ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "$TRAVIS_BRANCH" != "master" ] && DEPLOY=true || DEPLOY=false'
  - '[ "${DEPLOY}" = "true" ] && docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS'
  - '[ "${DEPLOY}" = "true" ] && docker push experimentalplatform/configure:${SERVICE_TAG}'
